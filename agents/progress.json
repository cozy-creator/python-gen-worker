{
  "issues": [
    {
      "id": 71,
      "name": "Dev HTTP Runner: Invoke Any Endpoint in a Worker Image via curl (Local Outputs)",
      "description": "Add a dev-only HTTP mode to python-gen-worker so a built worker image can be run locally and invoked with one-off HTTP requests (e.g. via curl), without standing up gen-orchestrator.\n\nGoals:\n- Start the container, mount a local output directory, then invoke any discovered endpoint/function with arbitrary JSON input.\n- All output files must be written to a mounted local directory (no Cozy Hub file API required).\n- Model weights should load on-demand during the first request (works today), but the dev server should also support explicit prefetch/warmup to avoid timeouts.\n\nNon-goals (v1):\n- Replacing the production scheduler protocol.\n- Matching every orchestrator behavior (autoscaling, queueing, JWT auth, etc.).\n\nKey design point:\n- In prod, the orchestrator instructs the worker via gRPC and provides per-run file capability tokens. In dev HTTP mode, we run the same function invocation engine in-process and swap the file backend to local-disk writes.\n",
      "tasks": [
        "[x] Define dev HTTP API contract\n    - Implemented:\n      - `POST /v1/run/{function_name}`\n      - `GET /v1/status`\n      - `GET /v1/models/status`\n      - `POST /v1/models/prefetch`\n      - `POST /v1/models/load`\n      - `POST /v1/models/unload`\n      - `POST /v1/warmup/{function_name}` (alias of run for init/warmup)",
        "[x] Implement local file backend for ActionContext\n    - `ActionContext(local_output_dir=...)` makes `ctx.save_*` write under that dir\n    - Preserves `runs/{run_id}/outputs/...` ref rules\n    - Returns `Asset(local_path=...)` + size_bytes + sha256 without HTTP",
        "[x] Implement dev HTTP server entrypoint\n    - `python -m gen_worker.testing.http_runner --listen ... --outputs ...`\n    - Loads user modules from baked `/app/.cozy/manifest.json` (configurable via `--manifest`)\n    - Reuses existing msgspec decoding + injection + downloader + pipeline loader\n    - Incremental functions: emits worker events in response (collected list; no SSE in v1)",
        "[x] Implement model prefetch/load/unload/warmup behavior\n    - Prefetch downloads into `WORKER_MODEL_CACHE_DIR` and marks models cached-on-disk\n    - load/unload reuse the existing worker load/unload handlers and report their results\n    - warmup executes the endpoint once (best-effort)",
        "[x] Docs + examples\n    - Documented a canonical local workflow in `README.md`",
        "[x] Tests\n    - Added unit test for `ActionContext(local_output_dir=...)` local save backend\n    - Added minimal HTTP runner test that invokes an endpoint and asserts file written under outputs dir"
      ],
      "completed": true
    },
    {
      "id": 72,
      "name": "Payload Chooses Repo By Short Key (pyproject.toml) + Manifest Metadata for Orchestrator Routing",
      "description": "Intended contract: a client payload can select a repo by a short string (e.g. `\"model\": \"sd15\"`) and that short string maps to a canonical Cozy repo ref declared ahead of time in `pyproject.toml` under `[tool.cozy.models]` (short-key -> `cozy:owner/repo[:tag][#component]`).\n\nToday, python-gen-worker supports signature-driven injection from payload via `Annotated[..., ModelRef(ModelRefSource.PAYLOAD, \"field_name\")]`, and resolves the chosen short key through the release-provided short-key mapping (legacy field name: `model_id_by_key`).\n\nWhat is missing for end-to-end cache-aware routing is making this contract explicit and exportable:\n- PAYLOAD values must be *keys*, not arbitrary refs\n- The orchestrator must know which payload fields select repos so it can compute required repo refs at submit-time",
      "tasks": [
        "[x] Enforce short-key semantics for ModelRef(PAYLOAD, ...)\n    - Require the payload value is a key present in the release short-key mapping (from `[tool.cozy.models]`)\n    - Unknown key: fail with a clear safe validation error (bounded list of allowed keys)\n    - Keep ModelRef(RELEASE, ...) behavior unchanged",
        "[x] Manifest metadata for orchestrator routing\n    - In `discover.py`, include which payload fields are repo selectors for each function\n    - Example: `payload_repo_selectors: [{\"field\":\"model\",\"kind\":\"short_key\"}]`\n    - Keep `injection_json` as the source of truth; this is a stable convenience for schedulers",
        "[x] Clarify manifest semantics\n    - `[tool.cozy.models]` defines the complete allowlisted keyspace and the repo ref each key maps to\n    - Ensure components (`#unet`, etc.) are representable in the ref value",
        "[x] Docs\n    - Show the pattern end-to-end: `[tool.cozy.models]` + payload short-key + `ModelRef(PAYLOAD, ...)`\n    - Document that direct repo refs in payload are not supported unless explicitly opted-in (future)",
        "[x] Tests\n    - Unit tests for PAYLOAD model selection: unknown key, known key, invalid types\n    - Discover-manifest test: `payload_repo_selectors` emitted when PAYLOAD injections exist"
      ],
      "completed": false
    },
    {
      "id": 73,
      "name": "Dockerfile-First Workers: cozy.toml Support in python-gen-worker (No tool.cozy in pyproject.toml)",
      "description": "Align python-gen-worker with Cozy Hub issue #102 (Dockerfile-first workers).\n\nTenants should not need any Cozy-specific configuration in `pyproject.toml`. Instead, Dockerfile-first workers use a `cozy.toml` manifest (flat schema).\n\nVersioning/compat policy update:\n- `cozy.toml` includes a `gen_worker` version constraint (for the `gen-worker` runtime library).\n- Cozy Hub validates the built image satisfies that constraint at publish time.\n- python-gen-worker does not need to emit extra version/audit events for this purpose.\n\npython-gen-worker must be able to:\n- read `cozy.toml` (for discovery import target and model-id mapping)\n- run discovery based on manifest `main`\n- stop parsing `[tool.cozy.*]` from `pyproject.toml`\n\nRelated Cozy Hub spec:\n- `~/cozy/cozy-hub/docs/cozy-toml.md`\n",
      "tasks": [
        "[x] Add cozy.toml manifest parser (v1)\n    - Implemented `src/gen_worker/cozy_toml.py` (tomllib)\n    - Supports: schema_version, name, main, gen_worker, [host.requirements].cuda, [models] mapping\n    - Supports optional per-endpoint model mapping: `[endpoints.<endpoint_name>.models]`\n    - Load path: `./cozy.toml` by default; env override `COZY_MANIFEST_PATH` (dev/testing only)",
        "[x] Update discovery to use cozy.toml\n    - Discovery requires cozy.toml (no Cozy config in pyproject.toml)\n    - Uses `main` as the import target for discovery (imports main, then inspects newly-imported modules)\n    - Uses `[models]` mapping (and optional `[endpoints.<endpoint_name>.models]`) as the model keyspace\n    - Emits per-function model mapping in the baked manifest under `models_by_function`",
        "[x] Update runtime model-key mapping contract\n    - Payload short-key selection (ModelRefSource.PAYLOAD) uses the baked `manifest.json` per-function mapping (`models_by_function`)\n    - Keeps the \"payload must be a short key\" safety rule\n    - Allows endpoint-specific model keyspaces so endpoints in the same release can support different models/dtypes",
        "[x] Manifest requirement\n    - Worker ENTRYPOINT requires `/app/.cozy/manifest.json` in the image (Dockerfile-first contract).\n    - The worker does not need cozy.toml at runtime; cozy.toml is build-time input only.",
        "[x] Optional: runtime validation (dev)\n    - Implemented dev-only check in `src/gen_worker/entrypoint.py`: if `COZY_MANIFEST_PATH` points at cozy.toml, validate installed gen-worker version satisfies `gen_worker` constraint (exit 2 on mismatch)\n    - Added unit tests for constraint evaluation in `tests/test_cozy_toml.py`",
        "[x] Docs\n    - Updated `README.md` to document Dockerfile-first contract + cozy.toml `[models]`\n    - Documented dtype table form and default dtype behavior",
        "[x] Tests\n    - Added cozy.toml parser tests: `tests/test_cozy_toml.py`\n    - Updated discovery model tests for dtype table form: `tests/test_discover_models.py`\n    - Added worker payload short-key mapping test: `tests/test_worker_model_keyspace.py`"
      ],
      "completed": false
    },
    {
      "id": 74,
      "name": "Endpoint-Constrained DType Selection (FP16/BF16/FP8) Across Cozy Hub + Orchestrator + Worker",
      "description": "Problem: gen-orchestrator cannot arbitrarily switch a repo's dtype/quantization (e.g. fp16 -> fp8) for an endpoint and expect tenant code to work. Some endpoints are written for fp16/bf16 pipelines, while fp8 requires different loading/runtime code.\n\nGoal: each endpoint (via its worker project manifest) must declare:\n- which repos/components it can use (already via `cozy.toml [models]` + `ModelRef(FIXED|PAYLOAD, ...)`)\n- which weight dtypes are acceptable for each model key (e.g. [\"fp16\",\"bf16\"], but NOT fp8 unless the endpoint explicitly opts in)\n\nOrchestrator must:\n- compute required repo refs for a request (static + payload-driven)\n- intersect client \"variant preferences\" (flashpack vs safetensors) with endpoint-allowed dtypes\n- resolve to a concrete variant ref (snapshot digest) that matches those constraints\n\nNotes:\n- Packaging differences (flashpack vs safetensors) should be transparent to tenant code; the worker loader handles it.\n- DType/quantization differences (fp16/bf16/fp8) are NOT transparent and must be constrained by the endpoint.\n",
      "tasks": [
        "[x] python-gen-worker: extend `cozy.toml [models]` to express allowed dtypes per key\n    - Supported TOML:\n      - `sdxl = { ref = \"hf:stabilityai/stable-diffusion-xl-base-1.0\", dtypes = [\"fp16\",\"bf16\"] }`\n      - `flux_fp8 = { ref = \"hf:black-forest-labs/FLUX.2-klein-4B\", dtypes = [\"fp8\"] }`\n    - Back-compat: if value is a string, treat it as `{ref=<string>, dtypes=[\"fp16\",\"bf16\"]}`\n    - Implemented in `src/gen_worker/cozy_toml.py`",
        "[x] python-gen-worker: discovery/manifest emits dtype constraints\n    - `python -m gen_worker.discover` emits per-function dtype constraints under `models_by_function[function_name][model_key] = {ref,dtypes}`\n    - Supports endpoint-specific mapping via `[endpoints.<endpoint_name>.models]`\n    - Tests cover string vs table forms and dtype defaults",
        "[x] gen-orchestrator: treat model keys as (repo ref + allowed dtypes)\n    - Persisted model-key dtype allowlists on the deployment projection (`allowed_dtypes_by_key`)\n    - Submit-time required repo computation now also produces per-repo dtype constraints (static + payload-selected)\n    - Rejects per-request dtype overrides outside the endpoint allowlist (safe validation error)\n    - Variant resolution filters Cozy Hub quantization preferences per repo ref\n    - Safety default: scheduler no longer includes fp8 in the global default quantization preference list",
        "[x] gen-orchestrator: client per-request variant preferences become bounded overrides\n    - Reused existing `VariantPreferences` (packaging/layout/quant) as the per-request metadata channel\n    - Enforced that `quant` stays within the endpoint-allowed dtypes (no fp8 unless endpoint allows it)",
        "[x] cozy-hub: expose dtype/quantization metadata for variants in resolve APIs\n    - `resolve_artifact` / `resolve_variant` responses include `file_type`, `file_layout`, and `quantization` for the chosen variant",
        "[ ] python-gen-worker: runtime enforcement and cache keys\n    - Ensure pipeline caching keys include variant ref (snapshot digest) AND dtype so fp16/bf16/fp8 don't collide\n    - Ensure the loader uses a torch_dtype consistent with the selected variant (esp. bf16 vs fp16 on CUDA)\n    - Fail fast if asked to load a variant dtype the endpoint did not declare (defense-in-depth; orchestrator should prevent this)",
        "[ ] End-to-end tests\n    - One endpoint declares dtypes=[fp16,bf16] and a repo; orchestrator must never resolve fp8 for it\n    - Another endpoint declares dtypes=[fp8] and uses fp8-specific tenant code; orchestrator must resolve fp8 and worker must load it\n    - Packaging preference (flashpack vs safetensors) can vary without changing tenant code"
      ],
      "completed": false
    }
  ]
}
