# example-functions/demo/Dockerfile (Revised)

# 1. Choose a Base Image (Same as before)
ARG CUDA_VERSION=12.6.0
ARG PYTHON_VERSION=3.12
ARG UBUNTU_VERSION=22.04
FROM nvidia/cuda:${CUDA_VERSION}-runtime-ubuntu${UBUNTU_VERSION}

RUN apt-get update && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-pip \
    python${PYTHON_VERSION}-venv \
    git \
    && rm -rf /var/lib/apt/lists/*
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${PYTHON_VERSION} 1 && \
    update-alternatives --set python3 /usr/bin/python${PYTHON_VERSION}

# 2. Set up Working Directory and Install uv
WORKDIR /app
RUN pip install uv

# 3. Copy and Install Dependencies (Same as before)
COPY src/gen_worker /app/gen_worker_src/src/gen_worker
COPY pyproject.toml /app/gen_worker_src/pyproject.toml
COPY example-functions/demo/pyproject.toml /app/user_project/pyproject.toml

WORKDIR /app/user_project
RUN uv pip install --system /app/gen_worker_src && \
    uv pip install --system .

# 4. Copy User's Application Code (Same as before)
COPY example-functions/demo/src /app/user_project/src

# 5. Define Entrypoint/Command (Simplified)
#    Set environment variables needed by gen_worker.entrypoint

ENV PYTHONUNBUFFERED=1
ENV SCHEDULER_ADDR="scheduler.service:8080"
# Set USER_MODULES to the name of the Python module inside src/ where the
# decorated functions live (e.g., 'demo' for src/demo/__init__.py)
ENV USER_MODULES="demo"

# Run the built-in entrypoint module from the installed gen_worker package
ENTRYPOINT ["python", "-m", "gen_worker.entrypoint"]
